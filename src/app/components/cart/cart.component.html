<!-- Floating cart removed: cart icon is now in header/nav -->

<!-- Full-Page Cart -->
<div 
  *ngIf="isCartOpen"
  class="fixed inset-0 z-50 bg-white overflow-hidden"
>
  <!-- Cart Container - Full Page -->
  <div class="h-full w-full bg-white cart-panel slide-in">
    <div class="h-full flex flex-col md:grid md:grid-cols-5 lg:grid-cols-3">
      <!-- Orders column (left on md) -->
      <div class="md:col-span-2 lg:col-span-1 border-r md:block hidden bg-gray-50 h-full orders-section">
        <div class="p-4 lg:p-6 h-full flex flex-col">
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-history text-[#006633]"></i>
            <h3 class="text-lg lg:text-xl font-semibold text-[#006633]">Your Orders</h3>
          </div>
          <div *ngIf="(orders$ | async) as orders" class="flex-1 overflow-hidden">
            <div *ngIf="orders.length === 0" class="text-center py-8">
              <i class="fas fa-receipt text-4xl text-gray-300 mb-3"></i>
              <p class="text-sm text-gray-500">No past orders yet.</p>
              <p class="text-xs text-gray-400 mt-1">Your order history will appear here</p>
            </div>
            <div *ngIf="orders.length > 0" class="h-full overflow-y-auto pr-2 orders-scroll-container">
            <div *ngFor="let order of orders" class="mb-4 p-4 border rounded-xl bg-white order-item shadow-sm">
              <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <i class="fas fa-receipt text-[#006633] text-sm"></i>
                    <div class="font-semibold text-gray-800">Order #{{ order.id }}</div>
                  </div>
                  <div class="text-xs text-gray-500 ml-5">{{ order.createdAt | date:'medium' }}</div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-[#006633] text-lg">KES {{ order.total.toLocaleString() }}</div>
                  <div class="text-xs text-gray-500">{{ order.items?.length || 0 }} items</div>
                </div>
              </div>
              <div class="mb-3 text-sm text-gray-700 bg-gray-50 p-2 rounded-lg">
                <div *ngIf="order.delivery" class="flex items-start gap-2">
                  <i class="fas fa-truck text-gray-400 text-xs mt-1"></i>
                  <div>
                    <div><strong>To:</strong> {{ order.delivery.name || 'N/A' }}</div>
                    <div><strong>Phone:</strong> {{ order.delivery.phone || 'N/A' }}</div>
                    <div *ngIf="order.delivery.address"><strong>Address:</strong> {{ order.delivery.address }}</div>
                  </div>
                </div>
              </div>
              <div class="flex gap-2">
                <!-- Show payment status or pay button -->
                <div *ngIf="order.payment; else payButton" class="flex-1 bg-green-100 border border-green-300 text-green-800 px-3 py-2 rounded-lg text-sm font-medium text-center">
                  <i class="fas fa-check-circle mr-1"></i> Payment Completed
                  <div class="text-xs mt-1">{{ order.payment.method }} - {{ order.payment.transactionId }}</div>
                </div>
                <ng-template #payButton>
                  <button (click)="openPayModal(order.id)" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm font-medium btn-pay transition-all duration-200">
                    <i class="fas fa-credit-card mr-1"></i> Pay Now
                  </button>
                </ng-template>
                <button (click)="reorder(order.id)" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium btn-secondary transition-all duration-200">
                  <i class="fas fa-redo mr-1"></i> Reorder
                </button>
              </div>
            </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Main cart column -->
      <div class="md:col-span-3 lg:col-span-2 h-full flex flex-col overflow-hidden">
    <!-- Header -->
    <div class="bg-[#006633] text-white p-4 lg:p-6 flex justify-between items-center cart-header shadow-lg flex-shrink-0">
      <div class="flex items-center gap-3">
        <button 
          (click)="toggleCart()"
          class="text-white hover:text-gray-200 text-xl hover:scale-110 transition-all duration-200 mr-3"
          title="Back to shop"
        >
          <i class="fas fa-arrow-left"></i>
        </button>
        <i class="fas fa-shopping-cart text-xl"></i>
        <h2 class="text-lg md:text-xl lg:text-2xl font-bold">Shopping Cart</h2>
      </div>
      <button 
        (click)="toggleCart()"
        class="text-white hover:text-red-200 text-2xl hover:scale-110 transition-all duration-200"
        title="Close cart"
      >
        âœ•
      </button>
    </div>

    <!-- Mobile orders collapsible inside cart panel -->
    <div class="md:hidden p-3 border-b">
        <button (click)="showOrdersMobile = !showOrdersMobile" class="w-full text-left p-2 bg-gray-100 rounded">
          <div class="flex justify-between items-center">
            <div class="font-semibold">Your Orders</div>
            <div class="text-sm text-gray-500">{{ (orders$ | async)?.length || 0 }} orders</div>
          </div>
        </button>
        <div *ngIf="showOrdersMobile" class="mt-2">
          <div *ngIf="(orders$ | async) as orders">
            <div *ngIf="orders.length === 0" class="text-sm text-gray-500 p-3">No past orders yet.</div>
            <div class="max-h-64 overflow-y-auto mobile-orders-scroll">
              <div *ngFor="let order of orders" class="mb-3 p-3 border rounded-lg">
              <div class="flex justify-between items-center">
                <div>
                  <div class="font-semibold">Order #{{ order.id }}</div>
                  <div class="text-xs text-gray-500">{{ order.createdAt | date:'medium' }}</div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-green-600">KES {{ order.total.toLocaleString() }}</div>
                </div>
              </div>
              <div class="mt-2 flex gap-2">
                <!-- Show payment status or pay button -->
                <div *ngIf="order.payment; else mobilePayButton" class="flex-1 bg-green-100 border border-green-300 text-green-800 px-2 py-1 rounded text-xs text-center">
                  <i class="fas fa-check-circle mr-1"></i> Completed
                </div>
                <ng-template #mobilePayButton>
                  <button (click)="openPayModal(order.id)" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors">
                    <i class="fas fa-credit-card mr-1"></i> Pay
                  </button>
                </ng-template>
                <button (click)="reorder(order.id)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs font-medium transition-colors">
                  <i class="fas fa-redo mr-1"></i> Reorder
                </button>
              </div>
            </div>
            </div>

            <!-- Back to shop for mobile orders view -->
            <div class="mt-3">
              <a routerLink="/shop" (click)="showOrdersMobile = false" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Back to shop</a>
            </div>
          </div>
        </div>
      </div>

    <!-- Cart Items -->
    <div class="flex-1 overflow-hidden flex flex-col">
      <div *ngIf="(cartItems$ | async)?.length === 0 && !showOrdersMobile" class="flex-1 flex items-center justify-center p-4 lg:p-6">
        <div class="text-center empty-cart">
          <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-4"></i>
          <h3 class="text-xl lg:text-2xl font-semibold text-[#006633] mb-2">Your cart is empty</h3>
          <p class="text-gray-500 mb-6">Add some fresh products to get started</p>
          <div class="mt-4">
            <a routerLink="/shop" (click)="toggleCart()" class="inline-flex items-center gap-2 bg-[#006633] hover:bg-[#008844] text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 shadow-lg hover:shadow-xl">
              <i class="fas fa-store"></i>
              Browse Products
            </a>
          </div>
        </div>
      </div>

      <div *ngIf="(cartItems$ | async)?.length! > 0" class="flex-1 overflow-y-auto p-4 lg:p-6 cart-items-scroll">
        <div *ngFor="let item of cartItems$ | async" class="mb-4 lg:mb-6 p-4 lg:p-5 border border-gray-200 rounded-xl cart-item shadow-sm hover:shadow-md transition-all duration-200">
        <!-- Product Info -->
        <div class="flex gap-4">
          <div class="relative">
            <img 
              [src]="item.product.image || 'https://res.cloudinary.com/dpls4kcqa/image/upload/v1748249717/WhatsApp_Image_2025-05-26_at_11.28.39_81ad0955_mmaps3.jpg'" 
              [alt]="item.product.name"
              class="w-16 h-16 lg:w-20 lg:h-20 object-cover rounded-xl shadow-sm"
              loading="lazy"
            >
            <div class="absolute -top-2 -right-2 bg-[#006633] text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
              {{ item.quantity }}
            </div>
          </div>
          <div class="flex-1">
            <h4 class="font-semibold text-gray-900 text-base lg:text-lg mb-1">{{ item.product.name }}</h4>
            <p class="text-sm lg:text-base text-[#006633] font-medium mb-1">{{ formatPrice(item.product.price) }}</p>
            <div class="flex items-center gap-2">
              <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">{{ item.product.category }}</span>
            </div>
          </div>
        </div>

        <!-- Quantity Controls & Actions -->
        <div class="flex items-center justify-between mt-4 pt-3 border-t border-gray-100">
          <div class="flex items-center gap-3">
            <button
              (click)="updateQuantity(item.product.id, item.quantity - 1)"
              class="w-9 h-9 lg:w-10 lg:h-10 bg-gray-100 hover:bg-gray-200 rounded-xl flex items-center justify-center text-gray-700 font-bold quantity-btn transition-all duration-200"
            >
              <i class="fas fa-minus text-xs"></i>
            </button>
            <span class="mx-2 font-semibold text-lg min-w-[2rem] text-center">{{ item.quantity }}</span>
            <button
              (click)="updateQuantity(item.product.id, item.quantity + 1)"
              class="w-9 h-9 lg:w-10 lg:h-10 bg-[#006633] hover:bg-[#008844] text-white rounded-xl flex items-center justify-center font-bold quantity-btn transition-all duration-200"
            >
              <i class="fas fa-plus text-xs"></i>
            </button>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <div class="font-semibold text-[#006633] text-lg">
                KES {{ ((item.product.price.min + item.product.price.max) / 2 * item.quantity).toLocaleString() }}
              </div>
              <div class="text-xs text-gray-500">
                {{ formatPrice(item.product.price) | slice:0:3 }} {{ ((item.product.price.min + item.product.price.max) / 2).toLocaleString() }} each
              </div>
            </div>
            <button
              (click)="removeFromCart(item.product.id)"
              class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all duration-200"
              title="Remove item"
            >
              <i class="fas fa-trash text-sm"></i>
            </button>
          </div>
        </div>
      </div>
      </div>
    </div>

    <!-- Footer -->
    <div *ngIf="(cartItems$ | async)?.length! > 0" class="border-t border-gray-200 p-4 lg:p-6 bg-gradient-to-r from-gray-50 to-green-50 pb-24 md:pb-4 flex-shrink-0">
      <!-- Total -->
      <div class="mb-6">
        <div class="bg-white p-4 rounded-xl shadow-sm border">
          <div class="flex justify-between items-center text-xl lg:text-2xl font-bold">
            <span class="text-gray-700">Order Total:</span>
            <span class="text-[#006633]">KES {{ getCartTotal().toLocaleString() }}</span>
          </div>
          <div class="text-sm text-gray-500 mt-1 text-right">
            {{ (cartItems$ | async)?.length }} items in cart
          </div>
        </div>
      </div>

      <!-- Delivery Inputs -->
      <div class="bg-white p-4 rounded-xl shadow-sm border mb-6">
        <div class="flex items-center gap-2 mb-4">
          <i class="fas fa-shipping-fast text-[#006633]"></i>
          <h4 class="font-semibold text-gray-800">Delivery Information</h4>
        </div>
        <div class="space-y-3">
          <div class="relative">
            <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
            <input [(ngModel)]="deliveryName" placeholder="Full name" class="w-full border border-gray-200 pl-10 pr-3 py-3 rounded-lg text-sm focus:border-[#006633] focus:ring-2 focus:ring-green-100 transition-all duration-200" />
          </div>
          <div class="relative">
            <i class="fas fa-phone absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
            <input [(ngModel)]="deliveryPhone" placeholder="Phone (e.g. +2547.. or 07.. )" class="w-full border border-gray-200 pl-10 pr-3 py-3 rounded-lg text-sm focus:border-[#006633] focus:ring-2 focus:ring-green-100 transition-all duration-200" />
          </div>
          <div class="relative">
            <i class="fas fa-map-marker-alt absolute left-3 top-4 text-gray-400 text-sm"></i>
            <input [(ngModel)]="deliveryAddress" placeholder="Delivery address" class="w-full border border-gray-200 pl-10 pr-3 py-3 rounded-lg text-sm focus:border-[#006633] focus:ring-2 focus:ring-green-100 transition-all duration-200" />
          </div>
          <div class="relative">
            <i class="fas fa-sticky-note absolute left-3 top-4 text-gray-400 text-sm"></i>
            <textarea [(ngModel)]="deliveryInstructions" placeholder="Delivery instructions (optional)" class="w-full border border-gray-200 pl-10 pr-3 py-3 rounded-lg text-sm focus:border-[#006633] focus:ring-2 focus:ring-green-100 transition-all duration-200 min-h-[80px]"></textarea>
          </div>
          <div class="flex items-center justify-between pt-2">
            <button (click)="pinMyLocation()" class="flex items-center gap-2 text-sm text-[#006633] hover:text-[#008844] font-medium transition-colors duration-200">
              <i class="fas fa-crosshairs"></i>
              Pin my location
            </button>
            <div *ngIf="deliveryCoords" class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full">
              <i class="fas fa-check-circle mr-1"></i>
              Location pinned
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="space-y-4">
        <div class="space-y-3">
          <button
            (click)="proceedToPayNow()"
            class="w-full bg-[#006633] hover:bg-[#008844] text-white py-4 px-6 rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 checkout-btn text-base md:text-lg"
          >
            <i class="fas fa-credit-card mr-2 text-lg md:text-xl"></i>
            Pay Now via M-Pesa
          </button>
          <button
            (click)="proceedToWhatsApp()"
            class="w-full bg-white hover:bg-green-50 text-[#006633] py-4 px-6 rounded-xl font-semibold border-2 border-[#006633] shadow-md hover:shadow-lg transition-all duration-300 text-base md:text-lg"
          >
            <i class="fab fa-whatsapp mr-2 text-lg md:text-xl text-green-600"></i>
            Order via WhatsApp (Pay Later)
          </button>
        </div>
        <div class="flex gap-3">
          <button
            (click)="clearCart()"
            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-4 rounded-xl font-medium transition-all duration-200 btn-secondary"
          >
            <i class="fas fa-trash mr-2"></i>
            Clear Cart
          </button>
          <!-- Mobile: toggle orders view -->
          <button (click)="showOrdersMobile = !showOrdersMobile" class="block md:hidden flex-1 text-center bg-[#006633] hover:bg-[#008844] text-white py-3 px-4 rounded-xl font-medium transition-all duration-200">
            <i class="fas fa-history mr-2"></i>
            View Orders
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile fixed Back to shop bar -->
<div *ngIf="isCartOpen" class="md:hidden fixed left-0 right-0 bottom-0 z-50 p-3 bg-white border-t mobile-back-bar shadow-lg">
  <div class="max-w-screen-md mx-auto">
    <a routerLink="/shop" (click)="toggleCart(); showOrdersMobile = false" class="w-full block text-center bg-[#006633] hover:bg-[#008844] text-white py-3 px-4 rounded-lg font-medium transition-all duration-200">
      <i class="fas fa-store mr-2"></i>
      Back to shop
    </a>
  </div>
</div>

  <!-- Inline receipt modal -->
  <app-receipt-modal *ngIf="showReceiptModal" [order]="receiptOrder" (close)="closeReceiptModal()"></app-receipt-modal>

<!-- Pay Modal -->
<div *ngIf="isPayModalOpen" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-mobile-alt text-2xl text-[#006633]"></i>
      </div>
      <h3 class="text-xl font-semibold text-gray-800 mb-2">Complete M-Pesa Payment</h3>
      <div class="bg-[#006633] text-white p-4 rounded-lg mb-4">
        <p class="text-sm mb-2">Send payment to:</p>
        <p class="text-2xl font-bold">0769920741</p>
        <p class="text-sm mt-2">Amount: <span class="font-bold">KES {{ getCartTotal() }}</span></p>
      </div>
      <p class="text-sm text-gray-600">Use Lipa Na M-Pesa, Till Number, or Paybill. After payment, enter your transaction code below.</p>
    </div>
    
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">M-Pesa Transaction Code</label>
      <input 
        [(ngModel)]="payTransactionId" 
        placeholder="e.g. QBR7GXXX" 
        class="w-full border border-gray-300 px-4 py-3 rounded-lg focus:border-[#006633] focus:ring-2 focus:ring-green-100 transition-all duration-200" 
      />
    </div>
    
    <div class="flex gap-3">
      <button 
        (click)="isPayModalOpen = false" 
        class="flex-1 px-4 py-3 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors duration-200"
      >
        Cancel
      </button>
      <button 
        (click)="confirmPayment()" 
        [disabled]="!payTransactionId"
        class="flex-1 px-4 py-3 rounded-lg bg-[#006633] hover:bg-[#008844] text-white font-medium transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <i class="fas fa-check mr-2"></i>
        Confirm Payment
      </button>
    </div>
  </div>
</div>

